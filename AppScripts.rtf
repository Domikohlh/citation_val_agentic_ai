{\rtf1\ansi\ansicpg1252\cocoartf2867
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fnil\fcharset0 Menlo-Regular;}
{\colortbl;\red255\green255\blue255;\red77\green80\blue85;\red246\green247\blue249;\red46\green49\blue51;
\red20\green67\blue174;\red186\green6\blue115;\red162\green0\blue16;\red18\green115\blue126;\red97\green3\blue173;
\red24\green25\blue27;}
{\*\expandedcolortbl;;\cssrgb\c37255\c38824\c40784;\cssrgb\c97255\c97647\c98039;\cssrgb\c23529\c25098\c26275;
\cssrgb\c9412\c35294\c73725;\cssrgb\c78824\c15294\c52549;\cssrgb\c70196\c7843\c7059;\cssrgb\c3529\c52157\c56863;\cssrgb\c46275\c15294\c73333;
\cssrgb\c12549\c12941\c14118;}
\paperw11900\paperh16840\margl1440\margr1440\vieww30040\viewh16360\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs26 \cf2 \cb3 \expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 // === CONFIGURATION ===\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 const\cf4 \strokec4  \cf6 \strokec6 ENDPOINT_URL\cf4 \strokec4  = \cf7 \strokec7 'https://undeprecatively-unpunctuated-kara.ngrok-free.dev/validate'\cf4 \strokec4 ; \cf2 \strokec2 // \uc0\u8592  UPDATE THIS WHEN NGROK CHANGES\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 const\cf4 \strokec4  \cf6 \strokec6 MAX_CITATION_LENGTH\cf4 \strokec4  = \cf8 \strokec8 1000\cf4 \strokec4 ; \cf2 \strokec2 // Max characters per citation line for processing\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // Split by two or more newlines, which typically separates bibliography entries.\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 const\cf4 \strokec4  \cf6 \strokec6 CITATION_SPLIT_REGEX\cf4 \strokec4  = \cf9 \strokec9 /\\n\{2,\}/\cf4 \strokec4 ; \cb1 \
\cf5 \cb3 \strokec5 const\cf4 \strokec4  \cf6 \strokec6 UI_SIDEBAR_TITLE\cf4 \strokec4  = \cf7 \strokec7 'Citation Validation Progress'\cf4 \strokec4 ;\cb1 \
\
\cf2 \cb3 \strokec2 // Add menu when document opens\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 onOpen\cf4 \strokec4 () \{\cb1 \
\cb3   \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ()\cb1 \
\cb3     .\cf10 \strokec10 createMenu\cf4 \strokec4 (\cf7 \strokec7 'Research Validator'\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 addItem\cf4 \strokec4 (\cf7 \strokec7 'Deep Validation: Single Reference'\cf4 \strokec4 , \cf7 \strokec7 'validateSelection'\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 addSeparator\cf4 \strokec4 ()\cb1 \
\cb3     .\cf10 \strokec10 addItem\cf4 \strokec4 (\cf7 \strokec7 'Bulk Validation: Reference List'\cf4 \strokec4 , \cf7 \strokec7 'validateReferenceList'\cf4 \strokec4 ) \cb1 \
\cb3     .\cf10 \strokec10 addSeparator\cf4 \strokec4 ()\cb1 \
\cb3     .\cf10 \strokec10 addItem\cf4 \strokec4 (\cf7 \strokec7 'Clear All Validation Colors'\cf4 \strokec4 , \cf7 \strokec7 'clearValidationColors'\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 addToUi\cf4 \strokec4 ();\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // Helper to call the Python backend\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 callBackend\cf4 \strokec4 (\cf10 \strokec10 text\cf4 \strokec4 ) \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 options\cf4 \strokec4  = \{\cb1 \
\cb3     \cf10 \strokec10 method\cf4 \strokec4 : \cf7 \strokec7 'post'\cf4 \strokec4 ,\cb1 \
\cb3     \cf10 \strokec10 contentType\cf4 \strokec4 : \cf7 \strokec7 'application/json'\cf4 \strokec4 ,\cb1 \
\cb3     \cf10 \strokec10 payload\cf4 \strokec4 : \cf6 \strokec6 JSON\cf4 \strokec4 .\cf10 \strokec10 stringify\cf4 \strokec4 (\{ \cf10 \strokec10 text\cf4 \strokec4 : \cf10 \strokec10 text\cf4 \strokec4  \}),\cb1 \
\cb3     \cf10 \strokec10 muteHttpExceptions\cf4 \strokec4 : \cf5 \strokec5 true\cf4 \strokec4 ,\cb1 \
\cb3     \cf10 \strokec10 headers\cf4 \strokec4 : \{ \cf7 \strokec7 'User-Agent'\cf4 \strokec4 : \cf7 \strokec7 'Google-Apps-Script'\cf4 \strokec4  \}\cb1 \
\cb3   \};\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 response\cf4 \strokec4  = \cf6 \strokec6 UrlFetchApp\cf4 \strokec4 .\cf10 \strokec10 fetch\cf4 \strokec4 (\cf6 \strokec6 ENDPOINT_URL\cf4 \strokec4 , \cf10 \strokec10 options\cf4 \strokec4 );\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 result\cf4 \strokec4  = \cf6 \strokec6 JSON\cf4 \strokec4 .\cf10 \strokec10 parse\cf4 \strokec4 (\cf10 \strokec10 response\cf4 \strokec4 .\cf10 \strokec10 getContentText\cf4 \strokec4 ());\cb1 \
\cb3   \cf5 \strokec5 return\cf4 \strokec4  \cf10 \strokec10 result\cf4 \strokec4 ;\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // Helper functions for UI (showSidebar, updateSidebarProgress, hideSidebar, showFinalReport)\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 // --- [UI Helper functions omitted for brevity, they are the same as the previous correct version] ---\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 // Helper to show the custom sidebar with the progress HTML\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 showSidebar\cf4 \strokec4 (\cf10 \strokec10 initialMessage\cf4 \strokec4 ) \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 html\cf4 \strokec4  = \cf6 \strokec6 HtmlService\cf4 \strokec4 .\cf10 \strokec10 createHtmlOutput\cf4 \strokec4 (\cf7 \strokec7 `<p style="font-family: sans-serif;">\cf4 \strokec4 $\{\cf10 \strokec10 initialMessage\cf4 \strokec4 \}\cf7 \strokec7 </p>`\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 setTitle\cf4 \strokec4 (\cf6 \strokec6 UI_SIDEBAR_TITLE\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 setWidth\cf4 \strokec4 (\cf8 \strokec8 300\cf4 \strokec4 );\cb1 \
\cb3   \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ().\cf10 \strokec10 showSidebar\cf4 \strokec4 (\cf10 \strokec10 html\cf4 \strokec4 );\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // Helper to update the sidebar with progress and a progress bar\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 updateSidebarProgress\cf4 \strokec4 (\cf10 \strokec10 current\cf4 \strokec4 , \cf10 \strokec10 total\cf4 \strokec4 , \cf10 \strokec10 currentItemText\cf4 \strokec4 ) \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 percentage\cf4 \strokec4  = \cf6 \strokec6 Math\cf4 \strokec4 .\cf10 \strokec10 round\cf4 \strokec4 ((\cf10 \strokec10 current\cf4 \strokec4  / \cf10 \strokec10 total\cf4 \strokec4 ) * \cf8 \strokec8 100\cf4 \strokec4 );\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 safeItemText\cf4 \strokec4  = \cf10 \strokec10 currentItemText\cf4 \strokec4 .\cf10 \strokec10 replace\cf4 \strokec4 (\cf9 \strokec9 /</\cf5 \strokec5 g\cf4 \strokec4 , \cf7 \strokec7 "&lt;"\cf4 \strokec4 ).\cf10 \strokec10 replace\cf4 \strokec4 (\cf9 \strokec9 />/\cf5 \strokec5 g\cf4 \strokec4 , \cf7 \strokec7 "&gt;"\cf4 \strokec4 );\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 htmlTemplate\cf4 \strokec4  = \cf7 \strokec7 `\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <style>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       body \{ font-family: sans-serif; padding: 10px; \}\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       .progress-bar-container \{ background-color: #f3f3f3; border-radius: 5px; overflow: hidden; margin-top: 10px; margin-bottom: 10px; \}\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       .progress-bar \{ height: 25px; background-color: #4CAF50; text-align: center; line-height: 25px; color: white; transition: width 0.3s; \}\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       .current-item \{ font-size: 0.9em; color: #555; white-space: pre-wrap; word-wrap: break-word; \}\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       .status \{ font-weight: bold; margin-top: 10px; \}\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     </style>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <div class="status">Citations Validated: \cf4 \strokec4 $\{\cf10 \strokec10 current\cf4 \strokec4 \}\cf7 \strokec7  / \cf4 \strokec4 $\{\cf10 \strokec10 total\cf4 \strokec4 \}\cf7 \strokec7  (\cf4 \strokec4 $\{\cf10 \strokec10 percentage\cf4 \strokec4 \}\cf7 \strokec7 %)</div>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <div class="progress-bar-container">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       <div class="progress-bar" style="width: \cf4 \strokec4 $\{\cf10 \strokec10 percentage\cf4 \strokec4 \}\cf7 \strokec7 %;">\cf4 \strokec4 $\{\cf10 \strokec10 percentage\cf4 \strokec4 \}\cf7 \strokec7 %</div>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     </div>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <div class="current-item">Processing: \cf4 \strokec4 $\{\cf10 \strokec10 safeItemText\cf4 \strokec4 \}\cf7 \strokec7 ...</div>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7   `\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 html\cf4 \strokec4  = \cf6 \strokec6 HtmlService\cf4 \strokec4 .\cf10 \strokec10 createHtmlOutput\cf4 \strokec4 (\cf10 \strokec10 htmlTemplate\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 setTitle\cf4 \strokec4 (\cf6 \strokec6 UI_SIDEBAR_TITLE\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 setWidth\cf4 \strokec4 (\cf8 \strokec8 300\cf4 \strokec4 );\cb1 \
\cb3   \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ().\cf10 \strokec10 showSidebar\cf4 \strokec4 (\cf10 \strokec10 html\cf4 \strokec4 );\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // Helper to hide the sidebar (by replacing it with a minimal, empty one)\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 hideSidebar\cf4 \strokec4 () \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 html\cf4 \strokec4  = \cf6 \strokec6 HtmlService\cf4 \strokec4 .\cf10 \strokec10 createHtmlOutput\cf4 \strokec4 (\cf7 \strokec7 ''\cf4 \strokec4 ).\cf10 \strokec10 setTitle\cf4 \strokec4 (\cf7 \strokec7 ''\cf4 \strokec4 ).\cf10 \strokec10 setHeight\cf4 \strokec4 (\cf8 \strokec8 1\cf4 \strokec4 );\cb1 \
\cb3   \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ().\cf10 \strokec10 showSidebar\cf4 \strokec4 (\cf10 \strokec10 html\cf4 \strokec4 );\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // Helper to display the final comprehensive report via a pop-up dialog\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 showFinalReport\cf4 \strokec4 (\cf10 \strokec10 results\cf4 \strokec4 , \cf10 \strokec10 total\cf4 \strokec4 ) \{\cb1 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 reportItemsHtml\cf4 \strokec4  = \cf7 \strokec7 ''\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 verifiedCount\cf4 \strokec4  = \cf8 \strokec8 0\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 falseCount\cf4 \strokec4  = \cf8 \strokec8 0\cf4 \strokec4 ;\cb1 \
\cb3   \cb1 \
\cb3   \cf10 \strokec10 results\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 ((\cf10 \strokec10 item\cf4 \strokec4 , \cf10 \strokec10 index\cf4 \strokec4 ) => \{\cb1 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 statusIcon\cf4 \strokec4  = \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 status\cf4 \strokec4 .\cf10 \strokec10 includes\cf4 \strokec4 (\cf7 \strokec7 'VERIFIED'\cf4 \strokec4 ) ? \cf7 \strokec7 '\uc0\u9989 '\cf4 \strokec4  : (\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 status\cf4 \strokec4 .\cf10 \strokec10 includes\cf4 \strokec4 (\cf7 \strokec7 'FALSE'\cf4 \strokec4 ) ? \cf7 \strokec7 '\uc0\u10060 '\cf4 \strokec4  : \cf7 \strokec7 '\uc0\u9888 \u65039 '\cf4 \strokec4 );\cb1 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 statusColor\cf4 \strokec4  = \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 status\cf4 \strokec4 .\cf10 \strokec10 includes\cf4 \strokec4 (\cf7 \strokec7 'VERIFIED'\cf4 \strokec4 ) ? \cf7 \strokec7 '#006400'\cf4 \strokec4  : (\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 status\cf4 \strokec4 .\cf10 \strokec10 includes\cf4 \strokec4 (\cf7 \strokec7 'FALSE'\cf4 \strokec4 ) ? \cf7 \strokec7 '#CC0000'\cf4 \strokec4  : \cf7 \strokec7 '#FF8800'\cf4 \strokec4 );\cb1 \
\cb3     \cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 status\cf4 \strokec4 .\cf10 \strokec10 includes\cf4 \strokec4 (\cf7 \strokec7 'VERIFIED'\cf4 \strokec4 )) \cf10 \strokec10 verifiedCount\cf4 \strokec4 ++;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 status\cf4 \strokec4 .\cf10 \strokec10 includes\cf4 \strokec4 (\cf7 \strokec7 'FALSE'\cf4 \strokec4 )) \cf10 \strokec10 falseCount\cf4 \strokec4 ++;\cb1 \
\
\cb3     \cf2 \strokec2 // FIX: Ensure item.sources is checked for existence.\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 sourcesHtml\cf4 \strokec4  = \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 sources\cf4 \strokec4  && \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 sources\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  > \cf8 \strokec8 0\cf4 \strokec4  ? \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 sources\cf4 \strokec4 .\cf10 \strokec10 map\cf4 \strokec4 ((\cf10 \strokec10 s\cf4 \strokec4 , \cf10 \strokec10 i\cf4 \strokec4 ) =>\cb1 \
\cb3         \cf7 \strokec7 `<li><a href="\cf4 \strokec4 $\{\cf10 \strokec10 s\cf4 \strokec4 .\cf10 \strokec10 url\cf4 \strokec4 \}\cf7 \strokec7 " target="_blank" style="color:#2a6496;">\cf4 \strokec4 $\{\cf10 \strokec10 s\cf4 \strokec4 .\cf10 \strokec10 title\cf4 \strokec4  || \cf7 \strokec7 'Source '\cf4 \strokec4  + (\cf10 \strokec10 i\cf4 \strokec4 +\cf8 \strokec8 1\cf4 \strokec4 )\}\cf7 \strokec7 </a></li>`\cf4 \strokec4  \cf2 \strokec2 // Fix 2\cf4 \cb1 \strokec4 \
\cb3     ).\cf10 \strokec10 join\cf4 \strokec4 (\cf7 \strokec7 ''\cf4 \strokec4 ) : \cf7 \strokec7 'No specific sources cited in this snippet.'\cf4 \strokec4 ;\cb1 \
\
\cb3     \cf10 \strokec10 reportItemsHtml\cf4 \strokec4  += \cf7 \strokec7 `\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7         <h4 style="margin: 0 0 5px 0; color: \cf4 \strokec4 $\{\cf10 \strokec10 statusColor\cf4 \strokec4 \}\cf7 \strokec7 ; font-size: 1.1em;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7           \cf4 \strokec4 $\{\cf10 \strokec10 index\cf4 \strokec4  + \cf8 \strokec8 1\cf4 \strokec4 \}\cf7 \strokec7 . \cf4 \strokec4 $\{\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 status\cf4 \strokec4 \}\cf7 \strokec7  \cf4 \strokec4 $\{\cf10 \strokec10 statusIcon\cf4 \strokec4 \}\cb1 \
\cf7 \cb3 \strokec7         </h4>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7         <p style="margin: 0 0 5px 0; font-size: 0.9em; font-style: italic; color: #555;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7           <strong>Citation:</strong> \cf4 \strokec4 $\{\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 citation\cf4 \strokec4 .\cf10 \strokec10 substring\cf4 \strokec4 (\cf8 \strokec8 0\cf4 \strokec4 , \cf8 \strokec8 150\cf4 \strokec4 )\}\cf7 \strokec7 ...\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7         </p>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7         <p style="margin: 0 0 5px 0; font-size: 0.95em;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7           <strong>Analysis:</strong> \cf4 \strokec4 $\{\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 analysis\cf4 \strokec4 .\cf10 \strokec10 substring\cf4 \strokec4 (\cf8 \strokec8 0\cf4 \strokec4 , \cf8 \strokec8 200\cf4 \strokec4 )\}\cf7 \strokec7 ...\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7         </p>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7         <p style="margin: 0 0 3px 0; font-size: 0.9em;"><strong>Sources Used:</strong></p>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7         <ul style="margin: 0; padding-left: 20px; font-size: 0.85em;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7           \cf4 \strokec4 $\{\cf10 \strokec10 sourcesHtml\cf4 \strokec4 \}\cb1 \
\cf7 \cb3 \strokec7         </ul>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       </div>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     `\cf4 \strokec4 ;\cb1 \
\cb3   \});\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 summaryHtml\cf4 \strokec4  = \cf7 \strokec7 `\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <h3 style="color:#333;">Batch Validation Summary (\cf4 \strokec4 $\{\cf10 \strokec10 total\cf4 \strokec4 \}\cf7 \strokec7  Processed)</h3>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <p style="font-size: 1.1em; margin-top: 10px;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       <span style="color:#006400; font-weight: bold;">\cf4 \strokec4 $\{\cf10 \strokec10 verifiedCount\cf4 \strokec4 \}\cf7 \strokec7  Verified</span>,\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       <span style="color:#CC0000; font-weight: bold;">\cf4 \strokec4 $\{\cf10 \strokec10 falseCount\cf4 \strokec4 \}\cf7 \strokec7  False Claims</span>,\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       <span style="color:#FF8800; font-weight: bold;">\cf4 \strokec4 $\{\cf10 \strokec10 total\cf4 \strokec4  - \cf10 \strokec10 verifiedCount\cf4 \strokec4  - \cf10 \strokec10 falseCount\cf4 \strokec4 \}\cf7 \strokec7  Uncertain/Errors</span>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     </p>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <hr style="margin: 15px 0;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7   `\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 htmlOutput\cf4 \strokec4  = \cf6 \strokec6 HtmlService\cf4 \strokec4 .\cf10 \strokec10 createHtmlOutput\cf4 \strokec4 (\cf7 \strokec7 `\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7     <div style="font-family: sans-serif; padding: 15px; max-height: 550px; overflow-y: scroll; background-color: #f9f9f9; border-radius: 8px;">\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7       \cf4 \strokec4 $\{\cf10 \strokec10 summaryHtml\cf4 \strokec4 \}\cb1 \
\cf7 \cb3 \strokec7       \cf4 \strokec4 $\{\cf10 \strokec10 reportItemsHtml\cf4 \strokec4 \}\cb1 \
\cf7 \cb3 \strokec7     </div>\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7   `\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 setWidth\cf4 \strokec4 (\cf8 \strokec8 650\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 setHeight\cf4 \strokec4 (\cf8 \strokec8 500\cf4 \strokec4 );\cb1 \
\
\cb3   \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ().\cf10 \strokec10 showModalDialog\cf4 \strokec4 (\cf10 \strokec10 htmlOutput\cf4 \strokec4 , \cf7 \strokec7 'Batch Validation Results'\cf4 \strokec4 );\cb1 \
\cb3 \}\cb1 \
\
\
\cb3  \cf5 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 validateReferenceList\cf4 \strokec4 () \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 ui\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 selection\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getActiveDocument\cf4 \strokec4 ().\cf10 \strokec10 getSelection\cf4 \strokec4 ();\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (!\cf10 \strokec10 selection\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'No text selected!'\cf4 \strokec4 , \cf7 \strokec7 'Please highlight the entire reference list or block of citations you want to validate.'\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \}\cb1 \
\
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 fullTextParts\cf4 \strokec4  = [];\cb1 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 citationElements\cf4 \strokec4  = [];\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 selectedRanges\cf4 \strokec4  = \cf10 \strokec10 selection\cf4 \strokec4 .\cf10 \strokec10 getRangeElements\cf4 \strokec4 ();\cb1 \
\
\cb3   \cf10 \strokec10 selectedRanges\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 (\cf10 \strokec10 rangeElement\cf4 \strokec4  => \{\cb1 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 element\cf4 \strokec4  = \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 getElement\cf4 \strokec4 ();\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 element\cf4 \strokec4 .\cf10 \strokec10 getType\cf4 \strokec4 () === \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf6 \strokec6 ElementType\cf4 \strokec4 .\cf6 \strokec6 PARAGRAPH\cf4 \strokec4  || \cf10 \strokec10 element\cf4 \strokec4 .\cf10 \strokec10 getType\cf4 \strokec4 () === \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf6 \strokec6 ElementType\cf4 \strokec4 .\cf6 \strokec6 LIST_ITEM\cf4 \strokec4 ) \{\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 textElement\cf4 \strokec4  = \cf10 \strokec10 element\cf4 \strokec4 .\cf10 \strokec10 asText\cf4 \strokec4 ();\cb1 \
\cb3       \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 start\cf4 \strokec4  = \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 isPartial\cf4 \strokec4 () ? \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 getStartOffset\cf4 \strokec4 () : \cf8 \strokec8 0\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 end\cf4 \strokec4  = \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 isPartial\cf4 \strokec4 () ? \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 getEndOffsetInclusive\cf4 \strokec4 () : \cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 getText\cf4 \strokec4 ().\cf10 \strokec10 length\cf4 \strokec4  - \cf8 \strokec8 1\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 text\cf4 \strokec4  = \cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 getText\cf4 \strokec4 ().\cf10 \strokec10 substring\cf4 \strokec4 (\cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 end\cf4 \strokec4  + \cf8 \strokec8 1\cf4 \strokec4 ).\cf10 \strokec10 trim\cf4 \strokec4 ();\cb1 \
\
\cb3       \cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 setForegroundColor\cf4 \strokec4 (\cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 end\cf4 \strokec4 , \cf5 \strokec5 null\cf4 \strokec4 ); \cf2 \strokec2 // clear previous\cf4 \cb1 \strokec4 \
\
\cb3       \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 text\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  > \cf8 \strokec8 0\cf4 \strokec4 ) \{\cb1 \
\cb3         \cf10 \strokec10 fullTextParts\cf4 \strokec4 .\cf10 \strokec10 push\cf4 \strokec4 (\cf10 \strokec10 text\cf4 \strokec4 );\cb1 \
\cb3         \cf10 \strokec10 citationElements\cf4 \strokec4 .\cf10 \strokec10 push\cf4 \strokec4 (\{ \cf10 \strokec10 textElement\cf4 \strokec4 , \cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 end\cf4 \strokec4  \});\cb1 \
\cb3       \}\cb1 \
\cb3     \}\cb1 \
\cb3   \});\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 fullTextParts\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  === \cf8 \strokec8 0\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'Empty selection'\cf4 \strokec4 , \cf7 \strokec7 'No valid text found.'\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \}\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 fullText\cf4 \strokec4  = \cf10 \strokec10 fullTextParts\cf4 \strokec4 .\cf10 \strokec10 join\cf4 \strokec4 (\cf7 \strokec7 '\\n\\n'\cf4 \strokec4 );\cb1 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 citations\cf4 \strokec4  = \cf10 \strokec10 fullText\cf4 \strokec4 .\cf10 \strokec10 trim\cf4 \strokec4 ().\cf10 \strokec10 split\cf4 \strokec4 (\cf6 \strokec6 CITATION_SPLIT_REGEX\cf4 \strokec4 )\cb1 \
\cb3     .\cf10 \strokec10 map\cf4 \strokec4 (\cf10 \strokec10 c\cf4 \strokec4  => \cf10 \strokec10 c\cf4 \strokec4 .\cf10 \strokec10 trim\cf4 \strokec4 ())\cb1 \
\cb3     .\cf10 \strokec10 filter\cf4 \strokec4 (\cf10 \strokec10 c\cf4 \strokec4  => \cf10 \strokec10 c\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  > \cf8 \strokec8 20\cf4 \strokec4  && \cf10 \strokec10 c\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  < \cf6 \strokec6 MAX_CITATION_LENGTH\cf4 \strokec4 );\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 citations\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  === \cf8 \strokec8 0\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'No citations found'\cf4 \strokec4 , \cf7 \strokec7 'Could not parse any valid citations. Check formatting (one citation per paragraph).'\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \}\cb1 \
\
\cb3   \cf2 \strokec2 // Warn if mismatch (optional)\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 citations\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  !== \cf10 \strokec10 citationElements\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'Warning'\cf4 \strokec4 , \cf7 \strokec7 `Parsed \cf4 \strokec4 $\{\cf10 \strokec10 citations\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 \}\cf7 \strokec7  citations from \cf4 \strokec4 $\{\cf10 \strokec10 citationElements\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 \}\cf7 \strokec7  paragraphs. Highlighting may be imperfect.\\n\\nTip: Use one citation per paragraph for best results.`\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3   \}\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 totalCitations\cf4 \strokec4  = \cf10 \strokec10 citations\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 ;\cb1 \
\cb3   \cf10 \strokec10 showSidebar\cf4 \strokec4 (\cf7 \strokec7 `Preparing to validate \cf4 \strokec4 $\{\cf10 \strokec10 totalCitations\cf4 \strokec4 \}\cf7 \strokec7  citations in batch...`\cf4 \strokec4 );\cb1 \
\
\cb3   \cf2 \strokec2 // === BATCH PROCESSING: Split into chunks of 15 (safe for time + payload size) ===\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf6 \strokec6 BATCH_SIZE\cf4 \strokec4  = \cf8 \strokec8 15\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 batches\cf4 \strokec4  = [];\cb1 \
\cb3   \cf5 \strokec5 for\cf4 \strokec4  (\cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 i\cf4 \strokec4  = \cf8 \strokec8 0\cf4 \strokec4 ; \cf10 \strokec10 i\cf4 \strokec4  < \cf10 \strokec10 citations\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 ; \cf10 \strokec10 i\cf4 \strokec4  += \cf6 \strokec6 BATCH_SIZE\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 batches\cf4 \strokec4 .\cf10 \strokec10 push\cf4 \strokec4 (\cf10 \strokec10 citations\cf4 \strokec4 .\cf10 \strokec10 slice\cf4 \strokec4 (\cf10 \strokec10 i\cf4 \strokec4 , \cf10 \strokec10 i\cf4 \strokec4  + \cf6 \strokec6 BATCH_SIZE\cf4 \strokec4 ));\cb1 \
\cb3   \}\cb1 \
\
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 validationResults\cf4 \strokec4  = [];\cb1 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 processed\cf4 \strokec4  = \cf8 \strokec8 0\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf5 \strokec5 try\cf4 \strokec4  \{\cb1 \
\cb3     \cf2 \strokec2 // Process each batch with fetchAll() \'97 parallel & fast!\cf4 \cb1 \strokec4 \
\cb3     \cf5 \strokec5 for\cf4 \strokec4  (\cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 b\cf4 \strokec4  = \cf8 \strokec8 0\cf4 \strokec4 ; \cf10 \strokec10 b\cf4 \strokec4  < \cf10 \strokec10 batches\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 ; \cf10 \strokec10 b\cf4 \strokec4 ++) \{\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 batch\cf4 \strokec4  = \cf10 \strokec10 batches\cf4 \strokec4 [\cf10 \strokec10 b\cf4 \strokec4 ];\cb1 \
\
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 requests\cf4 \strokec4  = \cf10 \strokec10 batch\cf4 \strokec4 .\cf10 \strokec10 map\cf4 \strokec4 ((\cf10 \strokec10 citation\cf4 \strokec4 , \cf10 \strokec10 idx\cf4 \strokec4 ) => (\{\cb1 \
\cb3         \cf10 \strokec10 url\cf4 \strokec4 : \cf6 \strokec6 ENDPOINT_URL\cf4 \strokec4 ,\cb1 \
\cb3         \cf10 \strokec10 method\cf4 \strokec4 : \cf7 \strokec7 'post'\cf4 \strokec4 ,\cb1 \
\cb3         \cf10 \strokec10 contentType\cf4 \strokec4 : \cf7 \strokec7 'application/json'\cf4 \strokec4 ,\cb1 \
\cb3         \cf10 \strokec10 payload\cf4 \strokec4 : \cf6 \strokec6 JSON\cf4 \strokec4 .\cf10 \strokec10 stringify\cf4 \strokec4 (\{ \cf10 \strokec10 text\cf4 \strokec4 : \cf10 \strokec10 citation\cf4 \strokec4  \}),\cb1 \
\cb3         \cf10 \strokec10 muteHttpExceptions\cf4 \strokec4 : \cf5 \strokec5 true\cf4 \strokec4 ,\cb1 \
\cb3         \cf10 \strokec10 headers\cf4 \strokec4 : \{ \cf7 \strokec7 'User-Agent'\cf4 \strokec4 : \cf7 \strokec7 'Google-Apps-Script'\cf4 \strokec4  \}\cb1 \
\cb3       \}));\cb1 \
\
\cb3       \cf10 \strokec10 updateSidebarProgress\cf4 \strokec4 (\cf10 \strokec10 processed\cf4 \strokec4  + \cf8 \strokec8 1\cf4 \strokec4 , \cf10 \strokec10 totalCitations\cf4 \strokec4 , \cf7 \strokec7 `Batch \cf4 \strokec4 $\{\cf10 \strokec10 b\cf4 \strokec4  + \cf8 \strokec8 1\cf4 \strokec4 \}\cf7 \strokec7 /\cf4 \strokec4 $\{\cf10 \strokec10 batches\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 \}\cf7 \strokec7  (\cf4 \strokec4 $\{\cf10 \strokec10 batch\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 \}\cf7 \strokec7  items)`\cf4 \strokec4 );\cb1 \
\
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 responses\cf4 \strokec4  = \cf6 \strokec6 UrlFetchApp\cf4 \strokec4 .\cf10 \strokec10 fetchAll\cf4 \strokec4 (\cf10 \strokec10 requests\cf4 \strokec4 );\cb1 \
\
\cb3       \cf10 \strokec10 responses\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 ((\cf10 \strokec10 response\cf4 \strokec4 , \cf10 \strokec10 idx\cf4 \strokec4 ) => \{\cb1 \
\cb3         \cf10 \strokec10 processed\cf4 \strokec4 ++;\cb1 \
\cb3         \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 citationIndex\cf4 \strokec4  = \cf10 \strokec10 b\cf4 \strokec4  * \cf6 \strokec6 BATCH_SIZE\cf4 \strokec4  + \cf10 \strokec10 idx\cf4 \strokec4 ;\cb1 \
\cb3         \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 citation\cf4 \strokec4  = \cf10 \strokec10 batch\cf4 \strokec4 [\cf10 \strokec10 idx\cf4 \strokec4 ];\cb1 \
\cb3         \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 elementInfo\cf4 \strokec4  = \cf10 \strokec10 citationElements\cf4 \strokec4 [\cf10 \strokec10 citationIndex\cf4 \strokec4 ] || \cf5 \strokec5 null\cf4 \strokec4 ;\cb1 \
\
\cb3         \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 result\cf4 \strokec4  = \{ \cf10 \strokec10 error\cf4 \strokec4 : \cf7 \strokec7 'Unknown response'\cf4 \strokec4  \};\cb1 \
\cb3         \cf5 \strokec5 try\cf4 \strokec4  \{\cb1 \
\cb3           \cf10 \strokec10 result\cf4 \strokec4  = \cf6 \strokec6 JSON\cf4 \strokec4 .\cf10 \strokec10 parse\cf4 \strokec4 (\cf10 \strokec10 response\cf4 \strokec4 .\cf10 \strokec10 getContentText\cf4 \strokec4 ());\cb1 \
\cb3         \} \cf5 \strokec5 catch\cf4 \strokec4  (\cf10 \strokec10 e\cf4 \strokec4 ) \{\cb1 \
\cb3           \cf10 \strokec10 result\cf4 \strokec4  = \{ \cf10 \strokec10 error\cf4 \strokec4 : \cf7 \strokec7 'Invalid JSON response'\cf4 \strokec4  \};\cb1 \
\cb3         \}\cb1 \
\
\cb3         \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 status\cf4 \strokec4  = \cf7 \strokec7 'UNCERTAIN'\cf4 \strokec4 , \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#FF8800'\cf4 \strokec4 ;\cb1 \
\cb3         \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 error\cf4 \strokec4  || !\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 analysis\cf4 \strokec4 ) \{\cb1 \
\cb3           \cf10 \strokec10 status\cf4 \strokec4  = \cf7 \strokec7 'ERROR'\cf4 \strokec4 ;\cb1 \
\cb3           \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#CC0000'\cf4 \strokec4 ;\cb1 \
\cb3         \} \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 verified\cf4 \strokec4  === \cf5 \strokec5 true\cf4 \strokec4 ) \{\cb1 \
\cb3           \cf10 \strokec10 status\cf4 \strokec4  = \cf7 \strokec7 'VERIFIED'\cf4 \strokec4 ;\cb1 \
\cb3           \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#006400'\cf4 \strokec4 ;\cb1 \
\cb3         \} \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 is_hallucination\cf4 \strokec4  === \cf5 \strokec5 true\cf4 \strokec4 ) \{\cb1 \
\cb3           \cf10 \strokec10 status\cf4 \strokec4  = \cf7 \strokec7 'FALSE CLAIM'\cf4 \strokec4 ;\cb1 \
\cb3           \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#CC0000'\cf4 \strokec4 ;\cb1 \
\cb3         \}\cb1 \
\
\cb3         \cf10 \strokec10 validationResults\cf4 \strokec4 .\cf10 \strokec10 push\cf4 \strokec4 (\{\cb1 \
\cb3           \cf10 \strokec10 citation\cf4 \strokec4 : \cf10 \strokec10 citation\cf4 \strokec4 ,\cb1 \
\cb3           \cf10 \strokec10 status\cf4 \strokec4 : \cf10 \strokec10 status\cf4 \strokec4 ,\cb1 \
\cb3           \cf10 \strokec10 color\cf4 \strokec4 : \cf10 \strokec10 color\cf4 \strokec4 ,\cb1 \
\cb3           \cf10 \strokec10 analysis\cf4 \strokec4 : \cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 analysis\cf4 \strokec4  || \cf7 \strokec7 `Error: \cf4 \strokec4 $\{\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 error\cf4 \strokec4  || \cf7 \strokec7 'No analysis'\cf4 \strokec4 \}\cf7 \strokec7 `\cf4 \strokec4 ,\cb1 \
\cb3           \cf10 \strokec10 sources\cf4 \strokec4 : \cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 suggested_citations\cf4 \strokec4  || [],\cb1 \
\cb3           \cf10 \strokec10 elementInfo\cf4 \strokec4 : \cf10 \strokec10 elementInfo\cf4 \cb1 \strokec4 \
\cb3         \});\cb1 \
\
\cb3         \cf2 \strokec2 // Update progress smoothly\cf4 \cb1 \strokec4 \
\cb3         \cf10 \strokec10 updateSidebarProgress\cf4 \strokec4 (\cf10 \strokec10 processed\cf4 \strokec4 , \cf10 \strokec10 totalCitations\cf4 \strokec4 , \cf10 \strokec10 citation\cf4 \strokec4 .\cf10 \strokec10 substring\cf4 \strokec4 (\cf8 \strokec8 0\cf4 \strokec4 , \cf8 \strokec8 80\cf4 \strokec4 ));\cb1 \
\cb3       \});\cb1 \
\
\cb3       \cf2 \strokec2 // Small delay between batches to be nice to your backend & avoid rate limits\cf4 \cb1 \strokec4 \
\cb3       \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 b\cf4 \strokec4  < \cf10 \strokec10 batches\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  - \cf8 \strokec8 1\cf4 \strokec4 ) \cf6 \strokec6 Utilities\cf4 \strokec4 .\cf10 \strokec10 sleep\cf4 \strokec4 (\cf8 \strokec8 1000\cf4 \strokec4 );\cb1 \
\cb3     \}\cb1 \
\
\cb3   \} \cf5 \strokec5 catch\cf4 \strokec4  (\cf10 \strokec10 error\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 hideSidebar\cf4 \strokec4 ();\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'Error'\cf4 \strokec4 , \cf7 \strokec7 `Batch processing failed: \cf4 \strokec4 $\{\cf10 \strokec10 error\cf4 \strokec4 .\cf10 \strokec10 toString\cf4 \strokec4 ()\}\cf7 \strokec7 \\n\\nCheck console logs.`\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3     \cf10 \strokec10 console\cf4 \strokec4 .\cf10 \strokec10 error\cf4 \strokec4 (\cf10 \strokec10 error\cf4 \strokec4 );\cb1 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \}\cb1 \
\
\cb3   \cf2 \strokec2 // === Finalize ===\cf4 \cb1 \strokec4 \
\cb3   \cf10 \strokec10 hideSidebar\cf4 \strokec4 ();\cb1 \
\
\cb3   \cf2 \strokec2 // Apply colors\cf4 \cb1 \strokec4 \
\cb3   \cf10 \strokec10 validationResults\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 (\cf10 \strokec10 r\cf4 \strokec4  => \{\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 r\cf4 \strokec4 .\cf10 \strokec10 elementInfo\cf4 \strokec4 ) \{\cb1 \
\cb3       \cf10 \strokec10 r\cf4 \strokec4 .\cf10 \strokec10 elementInfo\cf4 \strokec4 .\cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 setForegroundColor\cf4 \strokec4 (\cf10 \strokec10 r\cf4 \strokec4 .\cf10 \strokec10 elementInfo\cf4 \strokec4 .\cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 r\cf4 \strokec4 .\cf10 \strokec10 elementInfo\cf4 \strokec4 .\cf10 \strokec10 end\cf4 \strokec4 , \cf10 \strokec10 r\cf4 \strokec4 .\cf10 \strokec10 color\cf4 \strokec4 );\cb1 \
\cb3     \}\cb1 \
\cb3   \});\cb1 \
\
\cb3   \cf2 \strokec2 // === NEW: Detect and offer to remove duplicates ===\cf4 \cb1 \strokec4 \
\cb3   \cf10 \strokec10 detectAndHandleDuplicates\cf4 \strokec4 (\cf10 \strokec10 validationResults\cf4 \strokec4 );\cb1 \
\
\cb3   \cf2 \strokec2 // Show final report\cf4 \cb1 \strokec4 \
\cb3   \cf10 \strokec10 showFinalReport\cf4 \strokec4 (\cf10 \strokec10 validationResults\cf4 \strokec4 , \cf10 \strokec10 totalCitations\cf4 \strokec4 );\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // Main function: Validate currently selected text (SINGLE CLAIM)\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 validateSelection\cf4 \strokec4 () \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 doc\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getActiveDocument\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 ui\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 selection\cf4 \strokec4  = \cf10 \strokec10 doc\cf4 \strokec4 .\cf10 \strokec10 getSelection\cf4 \strokec4 ();\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (!\cf10 \strokec10 selection\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'No text selected!'\cf4 \strokec4 , \cf7 \strokec7 'Please highlight the text you want to fact-check.'\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \}\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 selectedRanges\cf4 \strokec4  = \cf10 \strokec10 selection\cf4 \strokec4 .\cf10 \strokec10 getRangeElements\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 fullText\cf4 \strokec4  = \cf7 \strokec7 ''\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 elementsToColor\cf4 \strokec4  = []; \cb1 \
\cb3   \cb1 \
\cb3   \cf10 \strokec10 selectedRanges\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 (\cf10 \strokec10 rangeElement\cf4 \strokec4  => \{\cb1 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 text\cf4 \strokec4  = \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 getElement\cf4 \strokec4 ().\cf10 \strokec10 asText\cf4 \strokec4 ();\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 isPartial\cf4 \strokec4 ()) \{\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 start\cf4 \strokec4  = \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 getStartOffset\cf4 \strokec4 ();\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 end\cf4 \strokec4  = \cf10 \strokec10 rangeElement\cf4 \strokec4 .\cf10 \strokec10 getEndOffsetInclusive\cf4 \strokec4 ();\cb1 \
\cb3       \cf10 \strokec10 fullText\cf4 \strokec4  += \cf10 \strokec10 text\cf4 \strokec4 .\cf10 \strokec10 getText\cf4 \strokec4 ().\cf10 \strokec10 substring\cf4 \strokec4 (\cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 end\cf4 \strokec4  + \cf8 \strokec8 1\cf4 \strokec4 );\cb1 \
\cb3       \cf10 \strokec10 elementsToColor\cf4 \strokec4 .\cf10 \strokec10 push\cf4 \strokec4 (\{ \cf10 \strokec10 textElement\cf4 \strokec4 : \cf10 \strokec10 text\cf4 \strokec4 , \cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 end\cf4 \strokec4  \});\cb1 \
\cb3     \} \cf5 \strokec5 else\cf4 \strokec4  \{\cb1 \
\cb3       \cf10 \strokec10 fullText\cf4 \strokec4  += \cf10 \strokec10 text\cf4 \strokec4 .\cf10 \strokec10 getText\cf4 \strokec4 ();\cb1 \
\cb3       \cf10 \strokec10 elementsToColor\cf4 \strokec4 .\cf10 \strokec10 push\cf4 \strokec4 (\{ \cf10 \strokec10 textElement\cf4 \strokec4 : \cf10 \strokec10 text\cf4 \strokec4 , \cf10 \strokec10 start\cf4 \strokec4 : \cf8 \strokec8 0\cf4 \strokec4 , \cf10 \strokec10 end\cf4 \strokec4 : \cf10 \strokec10 text\cf4 \strokec4 .\cf10 \strokec10 getText\cf4 \strokec4 ().\cf10 \strokec10 length\cf4 \strokec4  - \cf8 \strokec8 1\cf4 \strokec4  \});\cb1 \
\cb3     \}\cb1 \
\cb3   \});\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (!\cf10 \strokec10 fullText\cf4 \strokec4 .\cf10 \strokec10 trim\cf4 \strokec4 ()) \{\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'Empty selection'\cf4 \strokec4 , \cf7 \strokec7 'No text found in the selection.'\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3     \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \}\cb1 \
\cb3   \cb1 \
\cb3   \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cb1 \
\cb3     \cf7 \strokec7 'Analyzing with Gemini 2.5 Flash + Google Search...'\cf4 \strokec4 ,\cb1 \
\cb3     \cf7 \strokec7 'This takes 8\'9615 seconds.\\n\\nClick OK and wait for the result.'\cf4 \strokec4 ,\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \cb1 \strokec4 \
\cb3   );\cb1 \
\
\cb3   \cf5 \strokec5 try\cf4 \strokec4  \{\cb1 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 result\cf4 \strokec4  = \cf10 \strokec10 callBackend\cf4 \strokec4 (\cf10 \strokec10 fullText\cf4 \strokec4 .\cf10 \strokec10 trim\cf4 \strokec4 ());\cb1 \
\
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 error\cf4 \strokec4 ) \{\cb1 \
\cb3       \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'Server Error'\cf4 \strokec4 , \cf7 \strokec7 `Backend error: \cf4 \strokec4 $\{\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 error\cf4 \strokec4 \}\cf7 \strokec7 \\n\\nDetails: \cf4 \strokec4 $\{\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 details\cf4 \strokec4  || \cf7 \strokec7 'N/A'\cf4 \strokec4 \}\cf7 \strokec7 `\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3       \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3     \}\cb1 \
\
\cb3     \cf10 \strokec10 elementsToColor\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 (\cf10 \strokec10 item\cf4 \strokec4  => \{\cb1 \
\cb3       \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 setForegroundColor\cf4 \strokec4 (\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 end\cf4 \strokec4 , \cf5 \strokec5 null\cf4 \strokec4 ); \cb1 \
\cb3     \});\cb1 \
\
\cb3     \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 message\cf4 \strokec4  = \cf7 \strokec7 ''\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 title\cf4 \strokec4  = \cf7 \strokec7 ''\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#FF8800'\cf4 \strokec4 ; \cb1 \
\
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 verified\cf4 \strokec4  === \cf5 \strokec5 true\cf4 \strokec4 ) \{\cb1 \
\cb3       \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#006400'\cf4 \strokec4 ; \cb1 \
\cb3       \cf10 \strokec10 title\cf4 \strokec4  = \cf7 \strokec7 'Verified & Grounded'\cf4 \strokec4 ;\cb1 \
\cb3       \cf10 \strokec10 message\cf4 \strokec4  = \cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 analysis\cf4 \strokec4  || \cf7 \strokec7 'This claim is supported by web sources.'\cf4 \strokec4 ;\cb1 \
\cb3     \} \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 is_hallucination\cf4 \strokec4  === \cf5 \strokec5 true\cf4 \strokec4 ) \{\cb1 \
\cb3       \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#CC0000'\cf4 \strokec4 ; \cb1 \
\cb3       \cf10 \strokec10 title\cf4 \strokec4  = \cf7 \strokec7 'FALSE CLAIM DETECTED'\cf4 \strokec4 ;\cb1 \
\cb3       \cf10 \strokec10 message\cf4 \strokec4  = \cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 analysis\cf4 \strokec4  || \cf7 \strokec7 'This claim is inaccurate or unsupported.'\cf4 \strokec4 ;\cb1 \
\cb3     \} \cf5 \strokec5 else\cf4 \strokec4  \{\cb1 \
\cb3       \cf10 \strokec10 color\cf4 \strokec4  = \cf7 \strokec7 '#FF8800'\cf4 \strokec4 ;\cb1 \
\cb3       \cf10 \strokec10 title\cf4 \strokec4  = \cf7 \strokec7 'Uncertain / Needs Review'\cf4 \strokec4 ;\cb1 \
\cb3       \cf10 \strokec10 message\cf4 \strokec4  = \cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 analysis\cf4 \strokec4  || \cf7 \strokec7 'Could not confidently verify this claim.'\cf4 \strokec4 ;\cb1 \
\cb3     \}\cb1 \
\
\cb3     \cf10 \strokec10 elementsToColor\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 (\cf10 \strokec10 item\cf4 \strokec4  => \{\cb1 \
\cb3       \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 setForegroundColor\cf4 \strokec4 (\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 end\cf4 \strokec4 , \cf10 \strokec10 color\cf4 \strokec4 ); \cb1 \
\cb3     \});\cb1 \
\
\cb3     \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 citationFootnote\cf4 \strokec4  = \cf7 \strokec7 ''\cf4 \strokec4 ;\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 suggested_citations\cf4 \strokec4  && \cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 suggested_citations\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  > \cf8 \strokec8 0\cf4 \strokec4 ) \{\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 top3\cf4 \strokec4  = \cf10 \strokec10 result\cf4 \strokec4 .\cf10 \strokec10 suggested_citations\cf4 \strokec4 .\cf10 \strokec10 slice\cf4 \strokec4 (\cf8 \strokec8 0\cf4 \strokec4 , \cf8 \strokec8 3\cf4 \strokec4 );\cb1 \
\cb3       \cf10 \strokec10 citationFootnote\cf4 \strokec4  = \cf10 \strokec10 top3\cf4 \strokec4 .\cf10 \strokec10 map\cf4 \strokec4 ((\cf10 \strokec10 s\cf4 \strokec4 , \cf10 \strokec10 i\cf4 \strokec4 ) =>\cb1 \
\cb3         \cf7 \strokec7 `\cf4 \strokec4 $\{\cf10 \strokec10 i\cf4 \strokec4 +\cf8 \strokec8 1\cf4 \strokec4 \}\cf7 \strokec7 . \cf4 \strokec4 $\{\cf10 \strokec10 s\cf4 \strokec4 .\cf10 \strokec10 title\cf4 \strokec4  || \cf7 \strokec7 'Source'\cf4 \strokec4 \}\cf7 \strokec7  \'97 \cf4 \strokec4 $\{\cf10 \strokec10 s\cf4 \strokec4 .\cf10 \strokec10 url\cf4 \strokec4  || \cf7 \strokec7 'Link unavailable'\cf4 \strokec4 \}\cf7 \strokec7 `\cf4 \cb1 \strokec4 \
\cb3       ).\cf10 \strokec10 join\cf4 \strokec4 (\cf7 \strokec7 '\\n'\cf4 \strokec4 );\cb1 \
\cb3       \cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 firstElement\cf4 \strokec4  = \cf10 \strokec10 selectedRanges\cf4 \strokec4 [\cf8 \strokec8 0\cf4 \strokec4 ].\cf10 \strokec10 getElement\cf4 \strokec4 ();\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 paragraph\cf4 \strokec4  = \cf10 \strokec10 firstElement\cf4 \strokec4 .\cf10 \strokec10 getParent\cf4 \strokec4 ();\cb1 \
\cb3       \cb1 \
\cb3       \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 paragraph\cf4 \strokec4  && \cf10 \strokec10 paragraph\cf4 \strokec4 .\cf10 \strokec10 getType\cf4 \strokec4 () === \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf6 \strokec6 ElementType\cf4 \strokec4 .\cf6 \strokec6 PARAGRAPH\cf4 \strokec4 ) \{\cb1 \
\cb3         \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 footnote\cf4 \strokec4  = \cf10 \strokec10 paragraph\cf4 \strokec4 .\cf10 \strokec10 asParagraph\cf4 \strokec4 ().\cf10 \strokec10 addFootnote\cf4 \strokec4 (\cf10 \strokec10 citationFootnote\cf4 \strokec4 );\cb1 \
\cb3         \cf10 \strokec10 footnote\cf4 \strokec4 .\cf10 \strokec10 getFootnoteContents\cf4 \strokec4 ().\cf10 \strokec10 setItalic\cf4 \strokec4 (\cf5 \strokec5 true\cf4 \strokec4 ).\cf10 \strokec10 setForegroundColor\cf4 \strokec4 (\cf7 \strokec7 '#555555'\cf4 \strokec4 );\cb1 \
\cb3       \}\cb1 \
\cb3     \}\cb1 \
\
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 fullMessage\cf4 \strokec4  = \cf7 \strokec7 `\cf4 \strokec4 $\{\cf10 \strokec10 title\cf4 \strokec4 \}\cf7 \strokec7 \\n\\n\cf4 \strokec4 $\{\cf10 \strokec10 message\cf4 \strokec4 \}\cf7 \strokec7 \\n\\n\cf4 \strokec4 $\{\cf10 \strokec10 citationFootnote\cf4 \strokec4  ? \cf7 \strokec7 'Sources:\\n'\cf4 \strokec4  + \cf10 \strokec10 citationFootnote\cf4 \strokec4  : \cf7 \strokec7 ''\cf4 \strokec4 \}\cf7 \strokec7 `\cf4 \strokec4 ;\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf10 \strokec10 title\cf4 \strokec4 , \cf10 \strokec10 fullMessage\cf4 \strokec4 .\cf10 \strokec10 trim\cf4 \strokec4 (), \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\
\cb3   \} \cf5 \strokec5 catch\cf4 \strokec4  (\cf10 \strokec10 error\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf10 \strokec10 console\cf4 \strokec4 .\cf10 \strokec10 error\cf4 \strokec4 (\cf10 \strokec10 error\cf4 \strokec4 );\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cb1 \
\cb3       \cf7 \strokec7 'Connection Failed'\cf4 \strokec4 ,\cb1 \
\cb3       \cf7 \strokec7 `Could not reach the validation server.\\n\\nError: \cf4 \strokec4 $\{\cf10 \strokec10 error\cf4 \strokec4 .\cf10 \strokec10 toString\cf4 \strokec4 ()\}\cf7 \strokec7 \\n\\nCheck your ngrok URL and internet connection.`\cf4 \strokec4 ,\cb1 \
\cb3       \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \cb1 \strokec4 \
\cb3     );\cb1 \
\cb3   \}\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // === BONUS: Clear all validation colors in the document ===\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 clearValidationColors\cf4 \strokec4 () \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 ui\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 response\cf4 \strokec4  = \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cb1 \
\cb3     \cf7 \strokec7 'Clear All Validation Colors?'\cf4 \strokec4 ,\cb1 \
\cb3     \cf7 \strokec7 'This will reset text colors in the entire document.\\n\\nContinue?'\cf4 \strokec4 ,\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 YES_NO\cf4 \cb1 \strokec4 \
\cb3   );\cb1 \
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 response\cf4 \strokec4  !== \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 Button\cf4 \strokec4 .\cf6 \strokec6 YES\cf4 \strokec4 ) \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 body\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getActiveDocument\cf4 \strokec4 ().\cf10 \strokec10 getBody\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 text\cf4 \strokec4  = \cf10 \strokec10 body\cf4 \strokec4 .\cf10 \strokec10 editAsText\cf4 \strokec4 ();\cb1 \
\cb3   \cf10 \strokec10 text\cf4 \strokec4 .\cf10 \strokec10 setForegroundColor\cf4 \strokec4 (\cf5 \strokec5 null\cf4 \strokec4 ); \cb1 \
\cb3   \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'All validation colors cleared!'\cf4 \strokec4 , \cf7 \strokec7 ''\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3 \}\cb1 \
\
\cf2 \cb3 \strokec2 // === NEW FUNCTION FOR DUPLICATES DETECTION ===\cf4 \cb1 \strokec4 \
\cf5 \cb3 \strokec5 function\cf4 \strokec4  \cf10 \strokec10 detectAndHandleDuplicates\cf4 \strokec4 (\cf10 \strokec10 validationResults\cf4 \strokec4 ) \{\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 ui\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getUi\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 seen\cf4 \strokec4  = \cf5 \strokec5 new\cf4 \strokec4  \cf6 \strokec6 Map\cf4 \strokec4 ();\cb1 \
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 duplicates\cf4 \strokec4  = [];\cb1 \
\
\cb3   \cf10 \strokec10 validationResults\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 ((\cf10 \strokec10 item\cf4 \strokec4 , \cf10 \strokec10 idx\cf4 \strokec4 ) => \{\cb1 \
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (!\cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 elementInfo\cf4 \strokec4 ) \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 text\cf4 \strokec4  = \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 citation\cf4 \strokec4 .\cf10 \strokec10 trim\cf4 \strokec4 ().\cf10 \strokec10 toLowerCase\cf4 \strokec4 ();\cb1 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 key\cf4 \strokec4  = \cf10 \strokec10 text\cf4 \strokec4 .\cf10 \strokec10 slice\cf4 \strokec4 (\cf8 \strokec8 0\cf4 \strokec4 , \cf8 \strokec8 200\cf4 \strokec4 ); \cf2 \strokec2 // First 200 chars usually enough to detect dupes\cf4 \cb1 \strokec4 \
\
\cb3     \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 seen\cf4 \strokec4 .\cf10 \strokec10 has\cf4 \strokec4 (\cf10 \strokec10 key\cf4 \strokec4 )) \{\cb1 \
\cb3       \cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 push\cf4 \strokec4 (\{\cb1 \
\cb3         \cf10 \strokec10 index\cf4 \strokec4 : \cf10 \strokec10 idx\cf4 \strokec4 ,\cb1 \
\cb3         \cf10 \strokec10 citation\cf4 \strokec4 : \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 citation\cf4 \strokec4 ,\cb1 \
\cb3         \cf10 \strokec10 elementInfo\cf4 \strokec4 : \cf10 \strokec10 item\cf4 \strokec4 .\cf10 \strokec10 elementInfo\cf4 \strokec4 ,\cb1 \
\cb3         \cf10 \strokec10 originalIndex\cf4 \strokec4 : \cf10 \strokec10 seen\cf4 \strokec4 .\cf5 \strokec5 get\cf4 \strokec4 (\cf10 \strokec10 key\cf4 \strokec4 )\cb1 \
\cb3       \});\cb1 \
\cb3     \} \cf5 \strokec5 else\cf4 \strokec4  \{\cb1 \
\cb3       \cf10 \strokec10 seen\cf4 \strokec4 .\cf5 \strokec5 set\cf4 \strokec4 (\cf10 \strokec10 key\cf4 \strokec4 , \cf10 \strokec10 idx\cf4 \strokec4 );\cb1 \
\cb3     \}\cb1 \
\cb3   \});\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4  === \cf8 \strokec8 0\cf4 \strokec4 ) \cf5 \strokec5 return\cf4 \strokec4 ;\cb1 \
\
\cb3   \cf2 \strokec2 // Show summary\cf4 \cb1 \strokec4 \
\cb3   \cf5 \strokec5 let\cf4 \strokec4  \cf10 \strokec10 dupList\cf4 \strokec4  = \cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 map\cf4 \strokec4 (\cf10 \strokec10 d\cf4 \strokec4  => \cb1 \
\cb3     \cf7 \strokec7 `\'95 "\cf4 \strokec4 $\{\cf10 \strokec10 d\cf4 \strokec4 .\cf10 \strokec10 citation\cf4 \strokec4 .\cf10 \strokec10 substring\cf4 \strokec4 (\cf8 \strokec8 0\cf4 \strokec4 , \cf8 \strokec8 80\cf4 \strokec4 )\}\cf7 \strokec7 ..."`\cf4 \cb1 \strokec4 \
\cb3   ).\cf10 \strokec10 join\cf4 \strokec4 (\cf7 \strokec7 '\\n'\cf4 \strokec4 );\cb1 \
\
\cb3   \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 response\cf4 \strokec4  = \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cb1 \
\cb3     \cf7 \strokec7 `Duplicate Citations Detected (\cf4 \strokec4 $\{\cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 \}\cf7 \strokec7 )`\cf4 \strokec4 ,\cb1 \
\cb3     \cf7 \strokec7 `Found \cf4 \strokec4 $\{\cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 \}\cf7 \strokec7  citation(s) that appear to be duplicates:\\n\\n\cf4 \strokec4 $\{\cf10 \strokec10 dupList\cf4 \strokec4 \}\cf7 \strokec7 \\n\\nDo you want to delete them from the document?`\cf4 \strokec4 ,\cb1 \
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 YES_NO\cf4 \cb1 \strokec4 \
\cb3   );\cb1 \
\
\cb3   \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 response\cf4 \strokec4  === \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 Button\cf4 \strokec4 .\cf6 \strokec6 YES\cf4 \strokec4 ) \{\cb1 \
\cb3     \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 body\cf4 \strokec4  = \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf10 \strokec10 getActiveDocument\cf4 \strokec4 ().\cf10 \strokec10 getBody\cf4 \strokec4 ();\cb1 \
\cb3     \cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 sort\cf4 \strokec4 ((\cf10 \strokec10 a\cf4 \strokec4 , \cf10 \strokec10 b\cf4 \strokec4 ) => \cf10 \strokec10 b\cf4 \strokec4 .\cf10 \strokec10 index\cf4 \strokec4  - \cf10 \strokec10 a\cf4 \strokec4 .\cf10 \strokec10 index\cf4 \strokec4 ); \cf2 \strokec2 // Delete from bottom up\cf4 \cb1 \strokec4 \
\
\cb3     \cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 forEach\cf4 \strokec4 (\cf10 \strokec10 dup\cf4 \strokec4  => \{\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \{ \cf10 \strokec10 textElement\cf4 \strokec4 , \cf10 \strokec10 start\cf4 \strokec4 , \cf10 \strokec10 end\cf4 \strokec4  \} = \cf10 \strokec10 dup\cf4 \strokec4 .\cf10 \strokec10 elementInfo\cf4 \strokec4 ;\cb1 \
\cb3       \cf5 \strokec5 const\cf4 \strokec4  \cf10 \strokec10 parent\cf4 \strokec4  = \cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 getParent\cf4 \strokec4 ();\cb1 \
\
\cb3       \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 parent\cf4 \strokec4 .\cf10 \strokec10 getType\cf4 \strokec4 () === \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf6 \strokec6 ElementType\cf4 \strokec4 .\cf6 \strokec6 PARAGRAPH\cf4 \strokec4 ) \{\cb1 \
\cb3         \cf10 \strokec10 parent\cf4 \strokec4 .\cf10 \strokec10 removeFromParent\cf4 \strokec4 ();\cb1 \
\cb3       \} \cf5 \strokec5 else\cf4 \strokec4  \cf5 \strokec5 if\cf4 \strokec4  (\cf10 \strokec10 parent\cf4 \strokec4 .\cf10 \strokec10 getType\cf4 \strokec4 () === \cf6 \strokec6 DocumentApp\cf4 \strokec4 .\cf6 \strokec6 ElementType\cf4 \strokec4 .\cf6 \strokec6 LIST_ITEM\cf4 \strokec4 ) \{\cb1 \
\cb3         \cf10 \strokec10 parent\cf4 \strokec4 .\cf10 \strokec10 removeFromParent\cf4 \strokec4 ();\cb1 \
\cb3       \} \cf5 \strokec5 else\cf4 \strokec4  \{\cb1 \
\cb3         \cf2 \strokec2 // Fallback: clear text\cf4 \cb1 \strokec4 \
\cb3         \cf10 \strokec10 textElement\cf4 \strokec4 .\cf10 \strokec10 setText\cf4 \strokec4 (\cf7 \strokec7 ''\cf4 \strokec4 );\cb1 \
\cb3       \}\cb1 \
\cb3     \});\cb1 \
\
\cb3     \cf10 \strokec10 ui\cf4 \strokec4 .\cf10 \strokec10 alert\cf4 \strokec4 (\cf7 \strokec7 'Duplicates Removed'\cf4 \strokec4 , \cf7 \strokec7 `\cf4 \strokec4 $\{\cf10 \strokec10 duplicates\cf4 \strokec4 .\cf10 \strokec10 length\cf4 \strokec4 \}\cf7 \strokec7  duplicate citation(s) have been deleted.`\cf4 \strokec4 , \cf10 \strokec10 ui\cf4 \strokec4 .\cf6 \strokec6 ButtonSet\cf4 \strokec4 .\cf6 \strokec6 OK\cf4 \strokec4 );\cb1 \
\cb3   \}\cb1 \
\cb3 \}\cb1 \
\
\
}